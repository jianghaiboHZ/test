# ============================================
# Azure DevOps CI/CD 流水线
# 适用于：Spring Boot + 前端分离项目
# 前端目录：web_frontend
# ============================================

trigger:
  branches:
    include:
      - main
      - dev

variables:
  - group: dev-variables
  - group: prod-variables

stages:

# =====================================================
# Stage 1 - Build（前后端一起构建）
# =====================================================
- stage: Build
  displayName: '构建应用（前后端）'
  jobs:
    - job: BuildJob
      pool:
        vmImage: 'ubuntu-latest'

      steps:

        # 1️⃣ 安装 JDK 21
        - task: JavaToolInstaller@0
          inputs:
            versionSpec: '21'
          displayName: '安装 JDK 21'

        # 2️⃣ 安装 Node.js
        - task: NodeTool@0
          inputs:
            versionSpec: '18.x'
          displayName: '安装 Node.js'

        # 3️⃣ 缓存 node_modules
        - task: Cache@2
          inputs:
            key: '"npm" | "$(Agent.OS)" | web_frontend/package-lock.json'
            restoreKeys: |
              npm | "$(Agent.OS)"
            path: '$(System.DefaultWorkingDirectory)/web_frontend/node_modules'
          displayName: '缓存 node_modules'

        # 4️⃣ 构建前端
        - script: |
            cd web_frontend
            npm ci
            npm run build
          displayName: '编译前端'

        # 5️⃣ 将前端 dist 复制到 Spring Boot 静态目录
        - task: CopyFiles@2
          inputs:
            sourceFolder: '$(System.DefaultWorkingDirectory)/web_frontend/dist'
            contents: '**'
            targetFolder: '$(System.DefaultWorkingDirectory)/src/main/resources/static'
            overwrite: true
          displayName: '复制前端文件到后端'

        # 6️⃣ Maven 打包
        - task: Maven@4
          inputs:
            mavenPomFile: 'pom.xml'
            goals: 'clean package'
          displayName: 'Maven 打包'

        # 7️⃣ 发布 JAR
        - task: PublishBuildArtifacts@1
          inputs:
            PathtoPublish: '$(System.DefaultWorkingDirectory)/target/*.jar'
            ArtifactName: 'app_jar'
          displayName: '发布构建产物'


# =====================================================
# Stage 2 - Dev 部署
# =====================================================
- stage: Deploy_Dev
  displayName: '部署到开发环境'
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/dev'))

  jobs:
    - deployment: DeployDevJob
      displayName: '部署到 Dev'
      environment: 'dev'

      strategy:
        runOnce:
          deploy:
            steps:
              - task: AzureWebApp@1
                displayName: '部署到开发 App Service'
                inputs:
                  azureSubscription: 'azure-prod-connection'
                  appType: 'webAppLinux'
                  appName: '$(APP_SERVICE_NAME)'
                  package: '$(Pipeline.Workspace)/app_jar/*.jar'
                  runtimeStack: 'JAVA|21'


# =====================================================
# Stage 3 - Prod 部署（带审批）
# =====================================================
- stage: Deploy_Prod
  displayName: '部署到生产环境'
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))

  jobs:
    - deployment: DeployProdJob
      displayName: '部署到 Prod'
      environment: 'prod'

      strategy:
        runOnce:
          deploy:
            steps:
              - task: AzureWebApp@1
                displayName: '部署到生产 App Service'
                inputs:
                  azureSubscription: 'azure-prod-connection'
                  appType: 'webAppLinux'
                  appName: '$(PROD_APP_SERVICE_NAME)'
                  package: '$(Pipeline.Workspace)/app_jar/*.jar'
                  runtimeStack: 'JAVA|21'
