# ============================================
# Azure DevOps CI/CD æµæ°´çº¿
# Spring Boot + å‰åç«¯åˆ†ç¦»
# Windows è‡ªæ‰˜ç®¡ Agent
# å…¨è‡ªåŠ¨ç¯å¢ƒå®‰è£… + ç¼“å­˜åŠ é€Ÿç»ˆæç‰ˆ
# ============================================

trigger:
  branches:
    include:
      - main
      - dev

variables:
  - group: jhb-dev-variables
  - group: jhb-prod-variables

  - name: JDK_VERSION
    value: '21'

  - name: MAVEN_VERSION
    value: '3.9.6'

  - name: NODE_VERSION
    value: '18.19.0'

  - name: TOOL_CACHE
    value: '$(Pipeline.Workspace)/.tools'

  - name: MAVEN_LOCAL_REPO
    value: '$(Pipeline.Workspace)/.m2/repository'


stages:

# =====================================================
# Stage 1 - Build
# =====================================================
- stage: Build
  displayName: 'æ„å»ºåº”ç”¨ï¼ˆå…¨è‡ªåŠ¨ç¯å¢ƒï¼‰'

  jobs:
    - job: BuildJob
      pool:
        name: doujyou-self-hosted

      steps:

# -----------------------------------------------------
# 1ï¸âƒ£ ç¼“å­˜å·¥å…·ç›®å½•
# -----------------------------------------------------
        - task: Cache@2
          inputs:
            key: '"tools" | "$(Agent.OS)"'
            path: '$(TOOL_CACHE)'
          displayName: 'ç¼“å­˜å·¥å…·ç›®å½•'

# -----------------------------------------------------
# 2ï¸âƒ£ è‡ªåŠ¨å®‰è£… JDK 21
# -----------------------------------------------------
        - powershell: |

            $jdkHome = "$(TOOL_CACHE)\jdk-$(JDK_VERSION)"

            if (!(Test-Path $jdkHome)) {

              Write-Host "Downloading JDK $(JDK_VERSION)..."

              New-Item -ItemType Directory -Force -Path "$(TOOL_CACHE)"

              $zipPath = "$(TOOL_CACHE)\jdk.zip"

              Invoke-WebRequest `
                -Uri "https://api.adoptium.net/v3/binary/latest/$(JDK_VERSION)/ga/windows/x64/jdk/hotspot/normal/eclipse" `
                -OutFile $zipPath

              Expand-Archive $zipPath -DestinationPath "$(TOOL_CACHE)" -Force

              $folder = Get-ChildItem "$(TOOL_CACHE)" |
                        Where-Object { $_.PSIsContainer -and $_.Name -like "jdk-$(JDK_VERSION)*" } |
                        Select-Object -First 1

              Rename-Item $folder.FullName $jdkHome
            }

            $env:JAVA_HOME = $jdkHome
            $env:PATH = "$jdkHome\bin;$env:PATH"

            java -version
          displayName: 'åˆå§‹åŒ– JDK'

# -----------------------------------------------------
# 3ï¸âƒ£ è‡ªåŠ¨å®‰è£… Node.js
# -----------------------------------------------------
        - powershell: |

            $nodeHome = "$(TOOL_CACHE)\node"

            if (!(Test-Path $nodeHome)) {

              Write-Host "Downloading Node.js $(NODE_VERSION)..."

              $zipPath = "$(TOOL_CACHE)\node.zip"

              Invoke-WebRequest `
                -Uri "https://nodejs.org/dist/v$(NODE_VERSION)/node-v$(NODE_VERSION)-win-x64.zip" `
                -OutFile $zipPath

              Expand-Archive $zipPath -DestinationPath "$(TOOL_CACHE)" -Force

              Rename-Item "$(TOOL_CACHE)\node-v$(NODE_VERSION)-win-x64" $nodeHome
            }

            $env:PATH = "$nodeHome;$env:PATH"

            node -v
            npm -v
          displayName: 'åˆå§‹åŒ– Node.js'

# -----------------------------------------------------
# 4ï¸âƒ£ ç¼“å­˜ node_modules
# -----------------------------------------------------
        - task: Cache@2
          inputs:
            key: '"npm" | "$(Agent.OS)" | web_frontend/package-lock.json'
            path: '$(System.DefaultWorkingDirectory)/web_frontend/node_modules'
          displayName: 'ç¼“å­˜ node_modules'

# -----------------------------------------------------
# 5ï¸âƒ£ æ„å»ºå‰ç«¯
# -----------------------------------------------------
        - powershell: |
            cd web_frontend
            npm ci
            npm run build
          displayName: 'æ„å»ºå‰ç«¯'

# -----------------------------------------------------
# 6ï¸âƒ£ å¤åˆ¶å‰ç«¯èµ„æºåˆ° Spring Boot
# -----------------------------------------------------
        - task: CopyFiles@2
          inputs:
            sourceFolder: '$(System.DefaultWorkingDirectory)/web_frontend/dist'
            contents: '**'
            targetFolder: '$(System.DefaultWorkingDirectory)/src/main/resources/static'
            overwrite: true
          displayName: 'å¤åˆ¶å‰ç«¯åˆ°åç«¯'

# -----------------------------------------------------
# 7ï¸âƒ£ è‡ªåŠ¨å®‰è£… Maven
# -----------------------------------------------------
        - powershell: |

            $mavenHome = "$(TOOL_CACHE)\maven-$(MAVEN_VERSION)"

            if (!(Test-Path $mavenHome)) {

              Write-Host "Downloading Maven $(MAVEN_VERSION)..."

              $zipPath = "$(TOOL_CACHE)\maven.zip"

              Invoke-WebRequest `
                -Uri "https://archive.apache.org/dist/maven/maven-3/$(MAVEN_VERSION)/binaries/apache-maven-$(MAVEN_VERSION)-bin.zip" `
                -OutFile $zipPath

              Expand-Archive $zipPath -DestinationPath "$(TOOL_CACHE)" -Force

              Rename-Item "$(TOOL_CACHE)\apache-maven-$(MAVEN_VERSION)" $mavenHome
            }

            $env:MAVEN_HOME = $mavenHome
            $env:PATH = "$mavenHome\bin;$env:PATH"

            mvn -version
          displayName: 'åˆå§‹åŒ– Maven'

# -----------------------------------------------------
# 8ï¸âƒ£ ç¼“å­˜ Maven æœ¬åœ°ä»“åº“
# -----------------------------------------------------
        - task: Cache@2
          inputs:
            key: '"m2" | "$(Agent.OS)" | pom.xml'
            path: '$(MAVEN_LOCAL_REPO)'
          displayName: 'ç¼“å­˜ Maven ä»“åº“'

# -----------------------------------------------------
# 9ï¸âƒ£ Maven æ„å»ºï¼ˆå¤šçº¿ç¨‹åŠ é€Ÿï¼‰
# -----------------------------------------------------
        - powershell: |

            $env:MAVEN_HOME = "$(TOOL_CACHE)\maven-$(MAVEN_VERSION)"
            $env:PATH = "$env:MAVEN_HOME\bin;$env:PATH"

            New-Item -ItemType Directory -Force -Path "$(MAVEN_LOCAL_REPO)"

            mvn clean package `
              -T 1C `
              -Dmaven.repo.local=$(MAVEN_LOCAL_REPO) `
              -DskipTests
          displayName: 'Maven æ„å»ºï¼ˆå¹¶å‘åŠ é€Ÿï¼‰'

# -----------------------------------------------------
# ğŸ”Ÿ å‘å¸ƒ JAR
# -----------------------------------------------------
        - task: PublishBuildArtifacts@1
          inputs:
            PathtoPublish: '$(System.DefaultWorkingDirectory)/target'
            ArtifactName: 'app_jar'
          displayName: 'å‘å¸ƒæ„å»ºäº§ç‰©'



# =====================================================
# Stage 2 - Dev éƒ¨ç½²
# =====================================================
- stage: Deploy_Dev
  displayName: 'éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ'
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/dev'))

  jobs:
    - deployment: DeployDevJob
      environment: 'dev'

      strategy:
        runOnce:
          deploy:
            steps:
              - task: AzureWebApp@1
                inputs:
                  azureSubscription: 'toyotecdap-test'
                  appType: 'webAppLinux'
                  appName: '$(APP_SERVICE_NAME)'
                  package: '$(Pipeline.Workspace)/app_jar/*.jar'
                  runtimeStack: 'JAVA|21'


# =====================================================
# Stage 3 - Prod éƒ¨ç½²
# =====================================================
- stage: Deploy_Prod
  displayName: 'éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ'
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))

  jobs:
    - deployment: DeployProdJob
      environment: 'prod'

      strategy:
        runOnce:
          deploy:
            steps:
              - task: AzureWebApp@1
                inputs:
                  azureSubscription: 'toyotecdap-test'
                  appType: 'webAppLinux'
                  appName: '$(PROD_APP_SERVICE_NAME)'
                  package: '$(Pipeline.Workspace)/app_jar/*.jar'
                  runtimeStack: 'JAVA|21'
