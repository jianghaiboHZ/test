# File: azure-pipelines.yml
trigger:
  branches:
    include:
      - dev
      - main
  paths:
    exclude:
      - '**/*.md'
      - 'docs/**'

pool:
  vmImage: 'ubuntu-latest'

variables:
  MAVEN_CACHE_FOLDER: '.m2/repository'
  JAVA_VERSION: '17'
  # 根据分支设置环境变量
  ${{ if eq(variables['Build.SourceBranchName'], 'main') }}:
    artifactName: 'app-prod'
  ${{ else }}:
    artifactName: 'app-dev'

steps:
# Step 1: Cache Maven dependencies
- task: Cache@2
  inputs:
    key: 'maven | "$(Agent.OS)" | pom.xml'
    restoreKeys: |
      maven | "$(Agent.OS)"
    path: $(MAVEN_CACHE_FOLDER)
  displayName: 'Cache Maven dependencies'

# Step 2: Setup Java 17
- task: JavaToolInstaller@0
  inputs:
    versionSpec: $(JAVA_VERSION)
    jdkArchitectureOption: 'x64'
    jdkSourceOption: 'PreInstalled'
  displayName: 'Setup JDK 17'

# Step 3: Maven build with tests
- task: Maven@4
  inputs:
    mavenPomFile: 'pom.xml'
    goals: 'clean package'
    options: '-B -DskipTests=false -Dmaven.test.failure.ignore=false'
    javaHomeOption: 'JDKVersion'
    jdkVersionOption: $(JAVA_VERSION)
    jdkArchitectureOption: 'x64'
    publishJUnitResults: true
    testResultsFiles: '**/surefire-reports/TEST-*.xml'
  displayName: 'Maven build and test'

# Step 4: Publish test results
- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'JUnit'
    testResultsFiles: '**/surefire-reports/TEST-*.xml'
    testRunTitle: 'Unit Tests - $(Build.SourceBranchName)'
  displayName: 'Publish test results'
  condition: succeededOrFailed()

# Step 5: Publish JAR artifact
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.SourcesDirectory)/target/*.jar'
    ArtifactName: '$(artifactName)'
    publishLocation: 'Container'
  displayName: 'Publish JAR artifact'