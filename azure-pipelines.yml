# Azure DevOps æµæ°´çº¿é…ç½® - Spring Boot Maven é¡¹ç›®
# æ­¤é…ç½®åŒ…å«CI/CDå®Œæ•´æµç¨‹ï¼Œä»ä»£ç ç¼–è¯‘åˆ°Azure Web Appéƒ¨ç½²

# è§¦å‘å™¨é…ç½® - å®šä¹‰ä½•æ—¶è‡ªåŠ¨è¿è¡Œç®¡é“
trigger:
  branches:
    include:
    - main          # ä¸»åˆ†æ”¯æ¨é€è§¦å‘
    - develop       # å¼€å‘åˆ†æ”¯æ¨é€è§¦å‘
    - release/*     # å‘å¸ƒåˆ†æ”¯è§¦å‘
  paths:
    exclude:        # æ’é™¤æ–‡æ¡£å˜æ›´è§¦å‘
    - README.md
    - '**/*.md'
    - 'docs/**'

# Pull Request éªŒè¯ - ä»£ç åˆå¹¶å‰è´¨é‡é—¨æ§
pr:
  branches:
    include:
    - main
    - develop

# å…¨å±€å˜é‡å®šä¹‰
variables:
  # é¡¹ç›®åŸºæœ¬ä¿¡æ¯
  project.name: 'my-spring-boot-app'
  java.version: '17'
  maven.version: '3.9.11'
  
  # æ„å»ºé…ç½®
  build.configuration: 'Release'
  maven.opts: '-DskipTests -Dspring.profiles.active=ci'
  
  # Azureèµ„æºé…ç½®ï¼ˆè¿™äº›å€¼å¯åœ¨ç®¡é“å˜é‡ä¸­è¦†ç›–ï¼‰
  azure.subscription: 'your-azure-service-connection'
  webapp.name: 'my-spring-app'
  
  # åŠŸèƒ½å¼€å…³
  run.integration.tests: 'false'
  deploy.to.production: 'false'

# ç¼“å­˜é…ç½® - åŠ é€Ÿåç»­æ„å»º
resources:
  repositories:
  - repository: self
    type: git

# ç®¡é“é˜¶æ®µå®šä¹‰
stages:

# ==================== é˜¶æ®µ1: ä»£ç è´¨é‡ä¸ç¼–è¯‘ ====================
- stage: Build
  displayName: 'ğŸ”¨ æ„å»ºä¸ä»£ç æ£€æŸ¥'
  jobs:
  - job: BuildAndTest
    displayName: 'ç¼–è¯‘å’Œæµ‹è¯•'
    pool: 'MySelfHostedAgents'

    # pool:
      # vmImage: 'ubuntu-latest'  # ä½¿ç”¨å¾®è½¯æ‰˜ç®¡çš„Ubuntuä»£ç†
    
    steps:
    # æ­¥éª¤1: æ£€å‡ºä»£ç 
    - checkout: self
      clean: true
      displayName: 'ğŸ“¥ æ£€å‡ºæºä»£ç '
    
    # æ­¥éª¤2: è®¾ç½®Javaç¯å¢ƒ
    - task: JavaToolInstaller@0
      displayName: 'â˜• å®‰è£… Java $(java.version)'
      inputs:
        versionSpec: $(java.version)
        jdkArchitectureOption: 'x64'
        jdkSourceOption: 'PreInstalled'
    
    # æ­¥éª¤3: ç¼“å­˜Mavenä¾èµ–ï¼ˆæå‡æ„å»ºé€Ÿåº¦ï¼‰
    - task: Cache@2
      displayName: 'ğŸ’¾ ç¼“å­˜ Maven ä¾èµ–'
      inputs:
        key: 'maven | "$(Agent.OS)" | pom.xml'
        restoreKeys: |
          maven | "$(Agent.OS)"
        path: $(Pipeline.Workspace)/.m2/repository
    
    # æ­¥éª¤4: ç¼–è¯‘ä»£ç 
    - task: Maven@4
      displayName: 'âš™ï¸ ç¼–è¯‘é¡¹ç›®'
      inputs:
        mavenPomFile: 'pom.xml'
        goals: 'compile'
        options: '$(maven.opts)'
        javaHomeOption: 'JDKVersion'
        jdkVersionOption: $(java.version)
        publishJUnitResults: false
    
    # æ­¥éª¤5: è¿è¡Œå•å…ƒæµ‹è¯•
    - task: Maven@4
      displayName: 'ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•'
      inputs:
        mavenPomFile: 'pom.xml'
        goals: 'test'
        options: '$(maven.opts)'
        javaHomeOption: 'JDKVersion'
        publishJUnitResults: true
        testResultsFiles: '**/surefire-reports/TEST-*.xml'
    
    # æ­¥éª¤6: æ‰“åŒ…åº”ç”¨
    - task: Maven@4
      displayName: 'ğŸ“¦ æ‰“åŒ…åº”ç”¨'
      inputs:
        mavenPomFile: 'pom.xml'
        goals: 'package'
        options: '$(maven.opts)'
        javaHomeOption: 'JDKVersion'
    
    # æ­¥éª¤7: å‘å¸ƒæµ‹è¯•ç»“æœ
    - task: PublishTestResults@2
      displayName: 'ğŸ“‹ å‘å¸ƒæµ‹è¯•ç»“æœ'
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '**/surefire-reports/TEST-*.xml'
        mergeTestResults: true
        testRunTitle: 'å•å…ƒæµ‹è¯•ç»“æœ'
    
    # æ­¥éª¤8: å‘å¸ƒæ„å»ºäº§ç‰©
    - task: PublishBuildArtifacts@1
      displayName: 'ğŸ“¤ å‘å¸ƒJARåŒ…'
      inputs:
        PathtoPublish: 'target/*.jar'
        ArtifactName: 'application'
        publishLocation: 'Container'


