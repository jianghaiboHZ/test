# ============================================
# Azure DevOps CI/CD æµæ°´çº¿
# Spring Boot + å‰åç«¯åˆ†ç¦»
# Windows è‡ªæ‰˜ç®¡ Agent
# ä¼ä¸šç¨³å®šæœ€ç»ˆä¿®å¤ç‰ˆï¼ˆå·²å½»åº•ä¿®å¤ Maven ç›®å½•é—®é¢˜ï¼‰
# ============================================

trigger:
  branches:
    include:
      - main
      - dev

variables:
  - group: jhb-dev-variables
  - group: jhb-prod-variables

  - name: JDK_VERSION
    value: '21'

  - name: MAVEN_VERSION
    value: '3.9.6'

  - name: NODE_VERSION
    value: '18.19.0'

  - name: TOOL_CACHE
    value: '$(Pipeline.Workspace)/.tools'

  - name: MAVEN_LOCAL_REPO
    value: '$(Pipeline.Workspace)/.m2/repository'


stages:

# =====================================================
# Stage 1 - Build
# =====================================================
- stage: Build
  displayName: 'æ„å»ºåº”ç”¨ï¼ˆä¼ä¸šæœ€ç»ˆç¨³å®šç‰ˆï¼‰'

  jobs:
    - job: BuildJob
      pool:
        name: doujyou-self-hosted

      steps:

# -----------------------------------------------------
# 0ï¸âƒ£ åˆå§‹åŒ–å·¥å…·ç›®å½•
# -----------------------------------------------------
        - powershell: |
            New-Item -ItemType Directory -Force -Path "$(TOOL_CACHE)"
          displayName: 'åˆå§‹åŒ–å·¥å…·ç›®å½•'

# -----------------------------------------------------
# 1ï¸âƒ£ ç¼“å­˜å·¥å…·ç›®å½•
# -----------------------------------------------------
        - task: Cache@2
          inputs:
            key: '"tools" | "$(Agent.OS)"'
            path: '$(TOOL_CACHE)'
          displayName: 'ç¼“å­˜å·¥å…·ç›®å½•'

# -----------------------------------------------------
# 2ï¸âƒ£ åˆå§‹åŒ– JDK
# -----------------------------------------------------
        - powershell: |
            $jdkRoot = "$(TOOL_CACHE)"
            $jdkFolder = Get-ChildItem $jdkRoot -Directory -Filter "jdk-$(JDK_VERSION)*" -ErrorAction SilentlyContinue | Select-Object -First 1

            if (!$jdkFolder) {

              Write-Host "Installing JDK $(JDK_VERSION)..."

              $zipPath = "$jdkRoot\jdk.zip"

              Invoke-WebRequest `
                -Uri "https://api.adoptium.net/v3/binary/latest/$(JDK_VERSION)/ga/windows/x64/jdk/hotspot/normal/eclipse" `
                -OutFile $zipPath

              Expand-Archive $zipPath -DestinationPath $jdkRoot -Force

              $jdkFolder = Get-ChildItem $jdkRoot -Directory -Filter "jdk-*" | Select-Object -First 1
            }

            $jdkHome = $jdkFolder.FullName
            $env:JAVA_HOME = $jdkHome
            $env:PATH = "$jdkHome\bin;$env:PATH"

            Write-Host "##vso[task.setvariable variable=JAVA_HOME]$jdkHome"
            Write-Host "##vso[task.prependpath]$jdkHome\bin"

            java -version
          displayName: 'åˆå§‹åŒ– JDK'

# -----------------------------------------------------
# 3ï¸âƒ£ åˆå§‹åŒ– Node
# -----------------------------------------------------
        - powershell: |
            $nodeRoot = "$(TOOL_CACHE)"
            $nodeFolder = "$nodeRoot\node-v$(NODE_VERSION)-win-x64"

            if (!(Test-Path "$nodeFolder\node.exe")) {

              Write-Host "Installing Node $(NODE_VERSION)..."

              $zipPath = "$nodeRoot\node.zip"

              Invoke-WebRequest `
                -Uri "https://nodejs.org/dist/v$(NODE_VERSION)/node-v$(NODE_VERSION)-win-x64.zip" `
                -OutFile $zipPath

              Expand-Archive $zipPath -DestinationPath $nodeRoot -Force
            }

            $env:PATH = "$nodeFolder;$env:PATH"
            Write-Host "##vso[task.prependpath]$nodeFolder"

            node -v
            npm -v
          displayName: 'åˆå§‹åŒ– Node.js'

# -----------------------------------------------------
# 4ï¸âƒ£ ç¼“å­˜ node_modules
# -----------------------------------------------------
        - task: Cache@2
          inputs:
            key: '"npm" | "$(Agent.OS)" | web_frontend/package-lock.json'
            path: '$(Build.SourcesDirectory)/web_frontend/node_modules'
          displayName: 'ç¼“å­˜ node_modules'

# -----------------------------------------------------
# 5ï¸âƒ£ æ„å»ºå‰ç«¯ï¼ˆå¼ºåˆ¶ç›®å½•ï¼‰
# -----------------------------------------------------
        - powershell: |
            Set-Location "$(Build.SourcesDirectory)/web_frontend"
            npm ci
            npm run build
          displayName: 'æ„å»ºå‰ç«¯'

# -----------------------------------------------------
# 6ï¸âƒ£ å¤åˆ¶å‰ç«¯èµ„æºåˆ°åç«¯
# -----------------------------------------------------
        - task: CopyFiles@2
          inputs:
            sourceFolder: '$(Build.SourcesDirectory)/web_frontend/dist'
            contents: '**'
            targetFolder: '$(Build.SourcesDirectory)/src/main/resources/static'
            overwrite: true
          displayName: 'å¤åˆ¶å‰ç«¯åˆ°åç«¯'

# -----------------------------------------------------
# 7ï¸âƒ£ åˆå§‹åŒ– Maven
# -----------------------------------------------------
        - powershell: |
            $mavenRoot = "$(TOOL_CACHE)"
            $mavenFolder = "$mavenRoot\apache-maven-$(MAVEN_VERSION)"

            if (!(Test-Path "$mavenFolder\bin\mvn.cmd")) {

              Write-Host "Installing Maven $(MAVEN_VERSION)..."

              $zipPath = "$mavenRoot\maven.zip"

              Invoke-WebRequest `
                -Uri "https://archive.apache.org/dist/maven/maven-3/$(MAVEN_VERSION)/binaries/apache-maven-$(MAVEN_VERSION)-bin.zip" `
                -OutFile $zipPath

              Expand-Archive $zipPath -DestinationPath $mavenRoot -Force
            }

            $env:MAVEN_HOME = $mavenFolder
            $env:PATH = "$mavenFolder\bin;$env:PATH"

            Write-Host "##vso[task.setvariable variable=MAVEN_HOME]$mavenFolder"
            Write-Host "##vso[task.prependpath]$mavenFolder\bin"

            mvn -version
          displayName: 'åˆå§‹åŒ– Maven'

# -----------------------------------------------------
# 8ï¸âƒ£ ç¼“å­˜ Maven ä»“åº“
# -----------------------------------------------------
        - task: Cache@2
          inputs:
            key: '"m2" | "$(Agent.OS)" | pom.xml'
            path: '$(MAVEN_LOCAL_REPO)'
          displayName: 'ç¼“å­˜ Maven ä»“åº“'

# -----------------------------------------------------
# 9ï¸âƒ£ Maven æ„å»ºï¼ˆå½»åº•ä¿®å¤ç‰ˆï¼‰
# -----------------------------------------------------
        - powershell: |

            Write-Host "å½“å‰ç›®å½•ï¼š"
            Get-Location

            Write-Host "å¼ºåˆ¶åˆ‡æ¢åˆ°æºç ç›®å½•..."
            Set-Location "$(Build.SourcesDirectory)"

            Write-Host "åˆ‡æ¢åç›®å½•ï¼š"
            Get-Location
            Get-ChildItem

            if (!(Test-Path "pom.xml")) {
                Write-Error "âŒ pom.xml not found!"
                exit 1
            }

            New-Item -ItemType Directory -Force -Path "$(MAVEN_LOCAL_REPO)"

            mvn clean package `
              -T 1C `
              -Dmaven.repo.local=$(MAVEN_LOCAL_REPO) `
              -DskipTests

          displayName: 'Maven æ„å»º'

# -----------------------------------------------------
# ğŸ”Ÿ å‘å¸ƒ JAR
# -----------------------------------------------------
        - task: PublishBuildArtifacts@1
          inputs:
            PathtoPublish: '$(Build.SourcesDirectory)/target'
            ArtifactName: 'app_jar'
          displayName: 'å‘å¸ƒæ„å»ºäº§ç‰©'


# =====================================================
# Stage 2 - Dev éƒ¨ç½²
# =====================================================
- stage: Deploy_Dev
  displayName: 'éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ'
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/dev'))

  jobs:
    - deployment: DeployDevJob
      environment: 'dev'
      pool:
        name: doujyou-self-hosted

      strategy:
        runOnce:
          deploy:
            steps:
              - download: current
                artifact: app_jar

              - task: AzureWebApp@1
                inputs:
                  azureSubscription: 'toyotecdap-test'
                  appType: 'webAppLinux'
                  appName: '$(APP_SERVICE_NAME)'
                  package: '$(Pipeline.Workspace)/app_jar/*.jar'
                  runtimeStack: 'JAVA|21'


# =====================================================
# Stage 3 - Prod éƒ¨ç½²
# =====================================================
- stage: Deploy_Prod
  displayName: 'éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ'
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))

  jobs:
    - deployment: DeployProdJob
      environment: 'prod'
      pool:
        name: doujyou-self-hosted

      strategy:
        runOnce:
          deploy:
            steps:
              - download: current
                artifact: app_jar

              - task: AzureWebApp@1
                inputs:
                  azureSubscription: 'toyotecdap-test'
                  appType: 'webAppLinux'
                  appName: '$(PROD_APP_SERVICE_NAME)'
                  package: '$(Pipeline.Workspace)/app_jar/*.jar'
                  runtimeStack: 'JAVA|21'
