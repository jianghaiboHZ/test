# ============================================
# Azure DevOps CI/CD 流水线
# Spring Boot + 前后端分离
# Windows 自托管 Agent
# 企业稳定最终版（含发布JAR整理机制）
# ============================================

trigger:
  branches:
    include:
      - main
      - dev

variables:
  - group: jhb-dev-variables
  - group: jhb-prod-variables

  - name: JDK_VERSION
    value: '21'

  - name: MAVEN_VERSION
    value: '3.9.6'

  - name: NODE_VERSION
    value: '18.19.0'

  - name: TOOL_CACHE
    value: '$(Pipeline.Workspace)/.tools'

  - name: MAVEN_LOCAL_REPO
    value: '$(Pipeline.Workspace)/.m2/repository'


stages:

# =====================================================
# Stage 1 - Build
# =====================================================
- stage: Build
  displayName: '构建应用（企业最终稳定版）'

  jobs:
    - job: BuildJob
      pool:
        name: doujyou-self-hosted

      steps:

        - powershell: |
            New-Item -ItemType Directory -Force -Path "$(TOOL_CACHE)"
          displayName: '初始化工具目录'

        - task: Cache@2
          inputs:
            key: '"tools" | "$(Agent.OS)"'
            path: '$(TOOL_CACHE)'
          displayName: '缓存工具目录'

        # ---------- JDK ----------
        - powershell: |
            $jdkRoot = "$(TOOL_CACHE)"
            $jdkFolder = Get-ChildItem $jdkRoot -Directory -Filter "jdk-$(JDK_VERSION)*" -ErrorAction SilentlyContinue | Select-Object -First 1

            if (!$jdkFolder) {
              Write-Host "Installing JDK $(JDK_VERSION)..."
              $zipPath = "$jdkRoot\jdk.zip"

              Invoke-WebRequest `
                -Uri "https://api.adoptium.net/v3/binary/latest/$(JDK_VERSION)/ga/windows/x64/jdk/hotspot/normal/eclipse" `
                -OutFile $zipPath

              Expand-Archive $zipPath -DestinationPath $jdkRoot -Force
              $jdkFolder = Get-ChildItem $jdkRoot -Directory -Filter "jdk-*" | Select-Object -First 1
            }

            $jdkHome = $jdkFolder.FullName
            $env:JAVA_HOME = $jdkHome
            $env:PATH = "$jdkHome\bin;$env:PATH"

            Write-Host "##vso[task.setvariable variable=JAVA_HOME]$jdkHome"
            Write-Host "##vso[task.prependpath]$jdkHome\bin"

            java -version
          displayName: '初始化 JDK'

        # ---------- Node ----------
        - powershell: |
            $nodeRoot = "$(TOOL_CACHE)"
            $nodeFolder = "$nodeRoot\node-v$(NODE_VERSION)-win-x64"

            if (!(Test-Path "$nodeFolder\node.exe")) {
              Write-Host "Installing Node $(NODE_VERSION)..."
              $zipPath = "$nodeRoot\node.zip"

              Invoke-WebRequest `
                -Uri "https://nodejs.org/dist/v$(NODE_VERSION)/node-v$(NODE_VERSION)-win-x64.zip" `
                -OutFile $zipPath

              Expand-Archive $zipPath -DestinationPath $nodeRoot -Force
            }

            $env:PATH = "$nodeFolder;$env:PATH"
            Write-Host "##vso[task.prependpath]$nodeFolder"

            node -v
            npm -v
          displayName: '初始化 Node.js'

        - task: Cache@2
          inputs:
            key: '"npm" | "$(Agent.OS)" | web_frontend/package-lock.json'
            path: '$(Build.SourcesDirectory)/web_frontend/node_modules'
          displayName: '缓存 node_modules'

        - powershell: |
            Set-Location "$(Build.SourcesDirectory)/web_frontend"
            npm ci
            npm run build
          displayName: '构建前端'

        - task: CopyFiles@2
          inputs:
            sourceFolder: '$(Build.SourcesDirectory)/web_frontend/dist'
            contents: '**'
            targetFolder: '$(Build.SourcesDirectory)/src/main/resources/static'
            overwrite: true
          displayName: '复制前端到后端'

        # ---------- Maven ----------
        - powershell: |
            $mavenRoot = "$(TOOL_CACHE)"
            $mavenFolder = "$mavenRoot\apache-maven-$(MAVEN_VERSION)"

            if (!(Test-Path "$mavenFolder\bin\mvn.cmd")) {
              Write-Host "Installing Maven $(MAVEN_VERSION)..."
              $zipPath = "$mavenRoot\maven.zip"

              Invoke-WebRequest `
                -Uri "https://archive.apache.org/dist/maven/maven-3/$(MAVEN_VERSION)/binaries/apache-maven-$(MAVEN_VERSION)-bin.zip" `
                -OutFile $zipPath

              Expand-Archive $zipPath -DestinationPath $mavenRoot -Force
            }

            $env:MAVEN_HOME = $mavenFolder
            $env:PATH = "$mavenFolder\bin;$env:PATH"

            Write-Host "##vso[task.prependpath]$mavenFolder\bin"
            mvn -version
          displayName: '初始化 Maven'

        - task: Cache@2
          inputs:
            key: '"m2" | "$(Agent.OS)" | pom.xml'
            path: '$(MAVEN_LOCAL_REPO)'
          displayName: '缓存 Maven 仓库'

        - powershell: |
            Set-Location "$(Build.SourcesDirectory)"
            New-Item -ItemType Directory -Force -Path "$(MAVEN_LOCAL_REPO)"

            mvn clean package `
              -T 1C `
              "-Dmaven.repo.local=$(MAVEN_LOCAL_REPO)" `
              -DskipTests
          displayName: 'Maven 构建'

        # =================================================
        # ⭐ 企业级新增步骤：整理唯一发布 JAR
        # =================================================
        - powershell: |
            $targetDir = "$(Build.SourcesDirectory)/target"
            $deployDir = "$(Build.SourcesDirectory)/deploy"

            New-Item -ItemType Directory -Force -Path $deployDir

            $jar = Get-ChildItem $targetDir -Filter "*.jar" |
                   Where-Object {
                       $_.Name -notmatch "original" -and
                       $_.Name -notmatch "sources" -and
                       $_.Name -notmatch "tests"
                   } |
                   Sort-Object LastWriteTime -Descending |
                   Select-Object -First 1

            if (!$jar) {
                Write-Error "未找到可发布的 JAR 文件"
                exit 1
            }

            Copy-Item $jar.FullName "$deployDir/app.jar" -Force

            Write-Host "最终发布文件："
            Get-ChildItem $deployDir
          displayName: '整理发布 JAR'

        - task: PublishBuildArtifacts@1
          inputs:
            PathtoPublish: '$(Build.SourcesDirectory)/deploy'
            ArtifactName: 'app_jar'
          displayName: '发布构建产物'


# =====================================================
# Stage 2 - Dev 部署
# =====================================================
- stage: Deploy_Dev
  displayName: '部署到开发环境'
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/dev'))

  jobs:
    - deployment: DeployDevJob
      environment: 'dev'
      pool:
        name: doujyou-self-hosted

      strategy:
        runOnce:
          deploy:
            steps:
              - download: current
                artifact: app_jar

              - task: AzureWebApp@1
                inputs:
                  azureSubscription: 'toyotecdap-test'
                  appType: 'webAppLinux'
                  appName: '$(APP_SERVICE_NAME)'
                  package: '$(Pipeline.Workspace)/app_jar/app.jar'
                  runtimeStack: 'JAVA|21'


# =====================================================
# Stage 3 - Prod 部署
# =====================================================
- stage: Deploy_Prod
  displayName: '部署到生产环境'
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))

  jobs:
    - deployment: DeployProdJob
      environment: 'prod'
      pool:
        name: doujyou-self-hosted

      strategy:
        runOnce:
          deploy:
            steps:
              - download: current
                artifact: app_jar

              - task: AzureWebApp@1
                inputs:
                  azureSubscription: 'toyotecdap-test'
                  appType: 'webAppLinux'
                  appName: '$(PROD_APP_SERVICE_NAME)'
                  package: '$(Pipeline.Workspace)/app_jar/app.jar'
                  runtimeStack: 'JAVA|21'
