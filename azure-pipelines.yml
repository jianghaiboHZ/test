# ============================================
# Azure DevOps CI/CD æµæ°´çº¿ï¼ˆé«˜çº§ç¼“å­˜ä¼˜åŒ–ç‰ˆï¼‰
# é€‚ç”¨äºï¼šSpring Boot + å‰ç«¯åˆ†ç¦»é¡¹ç›®
# Windows è‡ªæ‰˜ç®¡ Agent
# ============================================

trigger:
  branches:
    include:
      - main
      - dev

variables:
  - group: jhb-dev-variables
  - group: jhb-prod-variables

  - name: MAVEN_VERSION
    value: '3.9.6'

  - name: MAVEN_CACHE_FOLDER
    value: '$(Pipeline.Workspace)/.maven'

  - name: MAVEN_LOCAL_REPO
    value: '$(Pipeline.Workspace)/.m2/repository'

stages:

# =====================================================
# Stage 1 - Build
# =====================================================
- stage: Build
  displayName: 'æ„å»ºåº”ç”¨ï¼ˆå‰åç«¯ï¼‰'

  jobs:
    - job: BuildJob
      pool:
        name: doujyou-self-hosted

      steps:

        # 1ï¸âƒ£ ä½¿ç”¨ JDK 21
        - task: JavaToolInstaller@0
          inputs:
            versionSpec: '21'
            jdkArchitectureOption: 'x64'
            jdkSourceOption: 'PreInstalled'
          displayName: 'ä½¿ç”¨ JDK 21'

        # 2ï¸âƒ£ å®‰è£… Node.js
        - task: NodeTool@0
          inputs:
            versionSpec: '18.x'
          displayName: 'å®‰è£… Node.js'

        # 3ï¸âƒ£ ç¼“å­˜ node_modules
        - task: Cache@2
          inputs:
            key: '"npm" | "$(Agent.OS)" | web_frontend/package-lock.json'
            restoreKeys: |
              npm | "$(Agent.OS)"
            path: '$(System.DefaultWorkingDirectory)/web_frontend/node_modules'
          displayName: 'ç¼“å­˜ node_modules'

        # 4ï¸âƒ£ æ„å»ºå‰ç«¯
        - powershell: |
            cd web_frontend
            npm ci
            npm run build
          displayName: 'ç¼–è¯‘å‰ç«¯'

        # 5ï¸âƒ£ å¤åˆ¶å‰ç«¯åˆ°åç«¯
        - task: CopyFiles@2
          inputs:
            sourceFolder: '$(System.DefaultWorkingDirectory)/web_frontend/dist'
            contents: '**'
            targetFolder: '$(System.DefaultWorkingDirectory)/src/main/resources/static'
            overwrite: true
          displayName: 'å¤åˆ¶å‰ç«¯åˆ°åç«¯'

        # 6ï¸âƒ£ ç¼“å­˜ Maven å®‰è£…ç›®å½•
        - task: Cache@2
          inputs:
            key: '"maven" | "$(MAVEN_VERSION)"'
            path: '$(MAVEN_CACHE_FOLDER)'
          displayName: 'ç¼“å­˜ Maven'

        # 7ï¸âƒ£ åˆå§‹åŒ– Mavenï¼ˆä¸å­˜åœ¨åˆ™ä¸‹è½½ï¼‰
        - powershell: |

            $mavenHome = "$(MAVEN_CACHE_FOLDER)\apache-maven-$(MAVEN_VERSION)"

            if (!(Test-Path $mavenHome)) {
              Write-Host "Downloading Maven $(MAVEN_VERSION)..."

              New-Item -ItemType Directory -Force -Path "$(MAVEN_CACHE_FOLDER)"

              $zipPath = "$(MAVEN_CACHE_FOLDER)\maven.zip"

              Invoke-WebRequest `
                -Uri "https://archive.apache.org/dist/maven/maven-3/$(MAVEN_VERSION)/binaries/apache-maven-$(MAVEN_VERSION)-bin.zip" `
                -OutFile $zipPath

              Expand-Archive $zipPath -DestinationPath "$(MAVEN_CACHE_FOLDER)" -Force
            }

            $env:MAVEN_HOME = $mavenHome
            $env:PATH = "$mavenHome\bin;$env:PATH"

            mvn -version
          displayName: 'åˆå§‹åŒ– Maven'

        # 8ï¸âƒ£ ç¼“å­˜ Maven æœ¬åœ°ä»“åº“
        - task: Cache@2
          inputs:
            key: '"m2" | "$(Agent.OS)" | pom.xml'
            restoreKeys: |
              m2 | "$(Agent.OS)"
            path: '$(MAVEN_LOCAL_REPO)'
          displayName: 'ç¼“å­˜ Maven æœ¬åœ°ä»“åº“'

        # 9ï¸âƒ£ Maven æ„å»º
        - powershell: |

            $mavenHome = "$(MAVEN_CACHE_FOLDER)\apache-maven-$(MAVEN_VERSION)"
            $env:MAVEN_HOME = $mavenHome
            $env:PATH = "$mavenHome\bin;$env:PATH"

            New-Item -ItemType Directory -Force -Path "$(MAVEN_LOCAL_REPO)"

            mvn clean package `
              -Dmaven.repo.local=$(MAVEN_LOCAL_REPO) `
              -DskipTests
          displayName: 'Maven æ„å»º'

        # ğŸ”Ÿ å‘å¸ƒ JAR
        - task: PublishBuildArtifacts@1
          inputs:
            PathtoPublish: '$(System.DefaultWorkingDirectory)/target'
            ArtifactName: 'app_jar'
          displayName: 'å‘å¸ƒæ„å»ºäº§ç‰©'


# =====================================================
# Stage 2 - Dev éƒ¨ç½²
# =====================================================
- stage: Deploy_Dev
  displayName: 'éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ'
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/dev'))

  jobs:
    - deployment: DeployDevJob
      environment: 'dev'

      strategy:
        runOnce:
          deploy:
            steps:
              - task: AzureWebApp@1
                displayName: 'éƒ¨ç½²åˆ°å¼€å‘ App Service'
                inputs:
                  azureSubscription: 'toyotecdap-test'
                  appType: 'webAppLinux'
                  appName: '$(APP_SERVICE_NAME)'
                  package: '$(Pipeline.Workspace)/app_jar/*.jar'
                  runtimeStack: 'JAVA|21'


# =====================================================
# Stage 3 - Prod éƒ¨ç½²
# =====================================================
- stage: Deploy_Prod
  displayName: 'éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ'
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))

  jobs:
    - deployment: DeployProdJob
      environment: 'prod'

      strategy:
        runOnce:
          deploy:
            steps:
              - task: AzureWebApp@1
                displayName: 'éƒ¨ç½²åˆ°ç”Ÿäº§ App Service'
                inputs:
                  azureSubscription: 'toyotecdap-test'
                  appType: 'webAppLinux'
                  appName: '$(PROD_APP_SERVICE_NAME)'
                  package: '$(Pipeline.Workspace)/app_jar/*.jar'
                  runtimeStack: 'JAVA|21'
